"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}();function _asyncToGenerator(e){return function(){var t=e.apply(this,arguments);return new Promise(function(e,n){return function i(s,o){try{var r=t[s](o),a=r.value}catch(e){return void n(e)}if(!r.done)return Promise.resolve(a).then(function(e){i("next",e)},function(e){i("throw",e)});e(a)}("next")})}}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var Ajaxinate=function(){function e(t){_classCallCheck(this,e);var n=t||{};this.settings=Object.assign({method:"scroll",container:"#AjaxinateContainer",pagination:"#AjaxinatePagination",productCard:".product-card",offset:0,loadingText:"Loading",callback:null,saveHistory:!1,loader:!1},n),this.containerElement=document.querySelector(this.settings.container),this.paginationElement=document.querySelector(this.settings.pagination),this.productCardElement=document.querySelectorAll(this.settings.productCard),this.isLoaded=!1,this.initialize()}return _createClass(e,[{key:"initialize",value:function(){this.containerElement&&({click:this.addClickListener.bind(this),scroll:this.addScrollListeners.bind(this)}[this.settings.method](),this.settings.saveHistory&&this.addClickListenerProductCard(),console.log("isLoaded: "+this.isLoaded),this.settings.saveHistory&&0==this.isLoaded&&(console.log("adding event listener "+this.isLoaded),this.loadPreviousContent(),this.isLoaded=!0))}},{key:"addScrollListeners",value:function(){this.paginationElement&&(document.addEventListener("scroll",this.checkIfPaginationInView),window.addEventListener("resize",this.checkIfPaginationInView),window.addEventListener("orientationchange",this.checkIfPaginationInView))}},{key:"addClickListener",value:function(){this.paginationElement&&(this.nextPageLinkElement=this.paginationElement.querySelector("a"),this.clickActive=!0,void 0!==this.nextPageLinkElement&&null!==this.nextPageLinkElement&&this.nextPageLinkElement.addEventListener("click",this.preventMultipleClicks))}},{key:"preventMultipleClicks",value:function(e){e.preventDefault(),this.clickActive&&(this.nextPageLinkElement.innerText=this.settings.loadingText,this.nextPageUrl=this.nextPageLinkElement.href,this.clickActive=!1,this.loadMore())}},{key:"checkIfPaginationInView",value:function(){var e=this.paginationElement.getBoundingClientRect().top-this.settings.offset,t=this.paginationElement.getBoundingClientRect().bottom+this.settings.offset;e<=window.innerHeight&&t>=0&&(this.nextPageLinkElement=this.paginationElement.querySelector("a"),this.removeScrollListener(),this.nextPageLinkElement&&(this.nextPageLinkElement.innerText=this.settings.loadingText,this.nextPageUrl=this.nextPageLinkElement.href,this.loadMore()))}},{key:"addClickListenerProductCard",value:function(){if(this.productCardElement&&!this.containerElement.hasClickListener){var e=function(e){var t=e.target.closest(".product-card");t&&this.contains(t)&&(sessionStorage.setItem("scrollPosition",window.scrollY),console.log("product card clicked"))};this.containerElement.addEventListener("click",e),this.containerElement.addEventListener("touchstart",e),this.containerElement.hasClickListener=!0}}},{key:"addLoader",value:function(){var e=document.createElement("div");e.className="loader-container";var t=document.createElement("div");t.className="loader",e.appendChild(t),this.containerElement.appendChild(e)}},{key:"removeLoader",value:function(){this.containerElement.removeChild(document.querySelector(".loader-container"))}},{key:"loadPreviousContent",value:function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(){var t,n,i,s,o,r,a=this;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(t=window.location.search,n=new URLSearchParams(t),null!==(i=n.get("page"))){e.next=6;break}return this.scrollToSavedPosition(),e.abrupt("return");case 6:for(this.settings.loader&&this.addLoader(),s=[],o=function(e){console.log("loading previous page "+e),a.request=new XMLHttpRequest;var t=window.location.origin+window.location.pathname+"?page="+e;s.push(new Promise(function(e){a.request.onreadystatechange=function(){if(4===this.request.readyState&&this.request.responseXML&&200===this.request.status){var t=this.request.responseXML.querySelectorAll(this.settings.container)[0],n=this.request.responseXML.querySelectorAll(this.settings.pagination)[0];this.containerElement.insertAdjacentHTML("afterbegin",t.innerHTML),void 0===n||this.initialize(),e()}}.bind(a),a.request.open("GET",t),a.request.responseType="document",a.request.send()}))},r=i-1;r>=1;r--)o(r);return e.next=12,Promise.all(s);case 12:this.scrollToSavedPosition(),this.settings.loader&&this.removeLoader();case 14:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"scrollToSavedPosition",value:function(){var e=sessionStorage.getItem("scrollPosition");e&&(console.log("scrolling to saved position"),window.scrollTo({top:e,behavior:"smooth"}),sessionStorage.removeItem("scrollPosition"))}},{key:"loadMore",value:function(){this.request=new XMLHttpRequest,this.request.onreadystatechange=function(){if(this.request.responseXML&&4!==!this.request.readyState&&200!==!this.request.status){var e=this.request.responseXML.querySelectorAll(this.settings.container)[0],t=this.request.responseXML.querySelectorAll(this.settings.pagination)[0];this.containerElement.insertAdjacentHTML("beforeend",e.innerHTML),void 0===t?(this.settings.saveHistory&&window.history.pushState({path:this.nextPageUrl},"",this.nextPageUrl),this.removePaginationElement()):(this.paginationElement.innerHTML=t.innerHTML,this.settings.saveHistory&&window.history.pushState({path:this.nextPageUrl},"",this.nextPageUrl),this.settings.callback&&"function"==typeof this.settings.callback&&this.settings.callback(this.request.responseXML),this.initialize())}}.bind(this),this.request.open("GET",this.nextPageUrl),this.request.responseType="document",this.request.send()}},{key:"removeClickListener",value:function(){this.nextPageLinkElement.removeEventListener("click",this.preventMultipleClicks)}},{key:"removePaginationElement",value:function(){this.paginationElement.innerHTML="",this.destroy()}},{key:"removeScrollListener",value:function(){document.removeEventListener("scroll",this.checkIfPaginationInView),window.removeEventListener("resize",this.checkIfPaginationInView),window.removeEventListener("orientationchange",this.checkIfPaginationInView)}},{key:"destroy",value:function(){return{click:this.removeClickListener,scroll:this.removeScrollListener}[this.settings.method](),this}}]),e}();exports.default=Ajaxinate;
"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}();function _asyncToGenerator(e){return function(){var t=e.apply(this,arguments);return new Promise(function(e,i){return function n(s,o){try{var r=t[s](o),a=r.value}catch(e){return void i(e)}if(!r.done)return Promise.resolve(a).then(function(e){n("next",e)},function(e){n("throw",e)});e(a)}("next")})}}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var Ajaxinate=function(){function e(t){_classCallCheck(this,e);var i=t||{};this.settings=Object.assign({method:"scroll",container:"#AjaxinateContainer",pagination:"#AjaxinatePagination",productCard:".product-card",offset:0,loadingText:"Loading",callback:null,saveHistory:!1,loader:!1,scrollHistory:!1},i),this.containerElement=document.querySelector(this.settings.container),this.paginationElement=document.querySelector(this.settings.pagination),this.productCardElement=document.querySelectorAll(this.settings.productCard),this.addClickListener=this.addClickListener.bind(this),this.preventMultipleClicks=this.preventMultipleClicks.bind(this),this.checkIfPaginationInView=this.checkIfPaginationInView.bind(this),this.addScrollListeners=this.addScrollListeners.bind(this),this.addClickListenerProductCard=this.addClickListenerProductCard.bind(this),this.loadPreviousContent=this.loadPreviousContent.bind(this),this.scrollToSavedPosition=this.scrollToSavedPosition.bind(this),this.loadMore=this.loadMore.bind(this),this.removeClickListener=this.removeClickListener.bind(this),this.removePaginationElement=this.removePaginationElement.bind(this),this.removeScrollListener=this.removeScrollListener.bind(this),this.destroy=this.destroy.bind(this),this.isLoaded=!1,this.initialize()}return _createClass(e,[{key:"initialize",value:function(){this.containerElement&&({click:this.addClickListener.bind(this),scroll:this.addScrollListeners.bind(this)}[this.settings.method](),this.settings.saveHistory&&this.addClickListenerProductCard(),this.settings.saveHistory&&0==this.isLoaded&&(console.log("adding event listener "+this.isLoaded),this.loadPreviousContent(),this.isLoaded=!0),!this.settings.saveHistory&&this.settings.scrollHistory&&(this.addClickListenerProductCard(),this.scrollToSavedPosition()))}},{key:"addScrollListeners",value:function(){this.paginationElement&&(document.addEventListener("scroll",this.checkIfPaginationInView),window.addEventListener("resize",this.checkIfPaginationInView),window.addEventListener("orientationchange",this.checkIfPaginationInView))}},{key:"addClickListener",value:function(){this.paginationElement&&(this.nextPageLinkElement=this.paginationElement.querySelector("a"),this.clickActive=!0,void 0!==this.nextPageLinkElement&&null!==this.nextPageLinkElement&&this.nextPageLinkElement.addEventListener("click",this.preventMultipleClicks))}},{key:"preventMultipleClicks",value:function(e){e.preventDefault(),this.clickActive&&(this.nextPageLinkElement.innerText=this.settings.loadingText,this.nextPageUrl=this.nextPageLinkElement.href,this.clickActive=!1,this.loadMore())}},{key:"checkIfPaginationInView",value:function(){var e=this.paginationElement.getBoundingClientRect().top-this.settings.offset,t=this.paginationElement.getBoundingClientRect().bottom+this.settings.offset;e<=window.innerHeight&&t>=0&&(this.nextPageLinkElement=this.paginationElement.querySelector("a"),this.removeScrollListener(),this.nextPageLinkElement&&(this.nextPageLinkElement.innerText=this.settings.loadingText,this.nextPageUrl=this.nextPageLinkElement.href,this.loadMore()))}},{key:"addClickListenerProductCard",value:function(){if(this.productCardElement&&!this.containerElement.hasClickListener){var e=function(e){var t=e.target.closest(".product-card");t&&this.contains(t)&&(sessionStorage.setItem("scrollPosition",window.scrollY),sessionStorage.setItem("productId",t.id))};this.containerElement.addEventListener("click",e),this.containerElement.addEventListener("touchstart",e),this.containerElement.hasClickListener=!0}}},{key:"addLoader",value:function(){var e=document.createElement("div");e.className="loader-container";var t=document.createElement("div");t.className="loader",e.appendChild(t),this.containerElement.appendChild(e)}},{key:"removeLoader",value:function(){this.containerElement.removeChild(document.querySelector(".loader-container"))}},{key:"loadPreviousContent",value:function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(){var t,i,n,s,o,r,a,l,c=this;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.isLoadingPreviousContent){e.next=3;break}return console.log("loadPreviousContent is already running."),e.abrupt("return");case 3:if(this.isLoadingPreviousContent=!0,t=window.location.search,i=new URLSearchParams(t),null!==(n=i.get("page"))){e.next=11;break}return this.scrollToSavedPosition(),this.isLoadingPreviousContent=!1,e.abrupt("return");case 11:for(this.settings.loader&&this.addLoader(),s=[],o=[],r=function(e){console.log("loading previous page "+e);var t=window.location.origin+window.location.pathname+"?page="+e;o.push(new Promise(function(i){var n=new XMLHttpRequest;n.onreadystatechange=function(){if(4===n.readyState&&n.responseXML&&200===n.status){var t=n.responseXML.querySelectorAll(this.settings.container)[0];s[e]=t.innerHTML,i()}}.bind(c),n.open("GET",t),n.responseType="document",n.send()}))},a=n-1;a>=1;a--)r(a);return e.next=18,Promise.all(o);case 18:l=s.filter(function(e){return void 0!==e}).join(""),this.containerElement.insertAdjacentHTML("afterbegin",l),this.scrollToSavedPosition(),this.settings.loader&&this.removeLoader(),this.isLoadingPreviousContent=!1;case 23:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"scrollToSavedPosition",value:function(){var e=sessionStorage.getItem("scrollPosition"),t=sessionStorage.getItem("productId");if(e&&this.settings.scrollHistory&&(window.scrollTo({top:e,behavior:"auto"}),sessionStorage.removeItem("scrollPosition")),t&&this.settings.scrollHistory){var i=document.getElementById(t);i&&(i.scrollIntoView({behavior:"auto",block:"center"}),sessionStorage.removeItem("productId"))}}},{key:"loadMore",value:function(){this.request=new XMLHttpRequest,this.request.onreadystatechange=function(){if(this.request.responseXML&&4!==!this.request.readyState&&200!==!this.request.status){var e=this.request.responseXML.querySelectorAll(this.settings.container)[0],t=this.request.responseXML.querySelectorAll(this.settings.pagination)[0];this.containerElement.insertAdjacentHTML("beforeend",e.innerHTML),void 0===t?(window.history.pushState({path:this.nextPageUrl},"",this.nextPageUrl),this.removePaginationElement()):(this.paginationElement.innerHTML=t.innerHTML,window.history.pushState({path:this.nextPageUrl},"",this.nextPageUrl),this.settings.callback&&"function"==typeof this.settings.callback&&this.settings.callback(this.request.responseXML),this.initialize())}}.bind(this),this.request.open("GET",this.nextPageUrl),this.request.responseType="document",this.request.send()}},{key:"removeClickListener",value:function(){this.nextPageLinkElement.removeEventListener("click",this.preventMultipleClicks)}},{key:"removePaginationElement",value:function(){this.paginationElement.innerHTML="",this.destroy()}},{key:"removeScrollListener",value:function(){document.removeEventListener("scroll",this.checkIfPaginationInView),window.removeEventListener("resize",this.checkIfPaginationInView),window.removeEventListener("orientationchange",this.checkIfPaginationInView)}},{key:"destroy",value:function(){return{click:this.removeClickListener,scroll:this.removeScrollListener}[this.settings.method](),this}}]),e}();exports.default=Ajaxinate;